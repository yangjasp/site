<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jasper Yang">
<meta name="dcterms.date" content="2022-10-18">

<title>Jasper Yang - May the Luckiest Team Win</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Jasper Yang</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/yangjasp" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/jyang29" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../JasperYangCV20250330.pdf" rel="" target="">
 <span class="menu-text">CV</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#defining-luck" id="toc-defining-luck" class="nav-link active" data-scroll-target="#defining-luck">Defining Luck</a></li>
  <li><a href="#skill-vs.-luck-in-sports" id="toc-skill-vs.-luck-in-sports" class="nav-link" data-scroll-target="#skill-vs.-luck-in-sports">Skill vs.&nbsp;Luck in sports</a></li>
  <li><a href="#sports-on-the-luck-skill-spectrum" id="toc-sports-on-the-luck-skill-spectrum" class="nav-link" data-scroll-target="#sports-on-the-luck-skill-spectrum">Sports on the Luck-Skill Spectrum</a></li>
  <li><a href="#the-clutch-factor" id="toc-the-clutch-factor" class="nav-link" data-scroll-target="#the-clutch-factor">The Clutch Factor</a></li>
  <li><a href="#luck-is-a-boring-narrative-and-playoffs-are-fun-to-watch.-im-okay-with-thatfor-the-most-part" id="toc-luck-is-a-boring-narrative-and-playoffs-are-fun-to-watch.-im-okay-with-thatfor-the-most-part" class="nav-link" data-scroll-target="#luck-is-a-boring-narrative-and-playoffs-are-fun-to-watch.-im-okay-with-thatfor-the-most-part">Luck is a boring narrative and playoffs are fun to watch. I’m okay with that…for the most part</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">May the Luckiest Team Win</h1>
  <div class="quarto-categories">
    <div class="quarto-category">sports</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jasper Yang </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 18, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>The Los Angeles Dodgers, indisputably the best team in the 2022 Major League Baseball regular season, were eliminated from World Series contention last night after narrowly falling in a best-of-five series against the San Diego Padres. Although they defeated the Padres in 14 out of their 19 regular season matchups, many fans will look back on this year regarding the Dodgers as the inferior team, and their 2022 season is already being called an <a href="https://www.washingtonpost.com/sports/2022/10/16/dodgers-early-postseason-exit/">utter dissapointment</a>. This is of course not the first time that an American sports team’s legacy has been tarnished by a surprising playoff elimination. The 2014-15 Golden State Warriors, arguably the greatest NBA team of all time, famously blew a 3-1 lead to the Cleveland Cavaliers in the NBA finals, leading to pundits <a href="https://fanbuzz.com/nba/2016-golden-state-warriors/">questioning their greatness</a> and forcing me to use “arguably” in this sentence. The 2001 Seattle Mariners won the most regular season games in MLB history but failed to reach the World Series. The 2008 New England Patriots became only the second NFL team ever to finish the regular season undefeated only to lose to the six-loss New York Giants in the Super Bowl. This list could go on and on.</p>
<p>Unsurprisingly, each of these playoff eliminations has been quickly followed by hindsight explanations of why the team was doomed to fail. Sportswriters are already pointing fingers at the Dodger’s GM and manager for <a href="https://www.latimes.com/sports/dodgers/story/2022-10-15/dodgers-hernandez-game-4">poor strategic decisions</a>, and a quick Twitter search will reveal thousands of angry fans calling out the players for being “chokers” unable to handle the pressure of the postseason. While these criticisms may be warranted to a small extent, the main culprit for postseason upsets is something frequently pushed to distant background of discussions: bad luck.</p>
<section id="defining-luck" class="level2">
<h2 class="anchored" data-anchor-id="defining-luck">Defining Luck</h2>
<p>Luck is generally a widely understood term, but coming up with a technical definition is actually quite challenging and philosophical. The approach that resonates most with me is to first define skill as ability (including knowledge, physical traits, preparedness, etc.) that is applied to an activity by a participant, and then call everything else that influences the outcome luck. Put more simply, luck is everything outside of the participant’s control. Take, for example, a simple game where a participant randomly picks a marble out of a bag containing 4 red marbles and 1 blue marble and wins 1 dollar if they correctly predicted the color of the selected marble. Here, the skill is understanding that choosing red is the optimal winning strategy, but whether or not the participant actually wins ultimately boils down to luck<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p>Some of the references that I mention later in this post provide their own definitions of luck or avoid addressing the issue altogether, but I believe that establishing a rough definition is a necessary starting point for this discussion.</p>
</section>
<section id="skill-vs.-luck-in-sports" class="level2">
<h2 class="anchored" data-anchor-id="skill-vs.-luck-in-sports">Skill vs.&nbsp;Luck in sports</h2>
<p>There is no disputing the fact that it takes an incredible amount of skill to play a sport at a professional level. There is also no disputing the fact that a team of professional baseball players would beat my local recreational league team well more than 99.999% of the time. But because the MLB only features similarly high-skilled players, the <em>skill gap</em> is actually relatively small. When the skill gap is small, luck becomes a much more influential factor on the outcome.</p>
<p>To see how this works, take a simple example of free throws in basketball. According to <a href="https://www.statmuse.com/nba/ask/steph-curry-career-ts-percentage">Statmuse</a>, Stephen Curry has made 90.8% of his free throws in his career. Thus, if we consider each shot as independent, it is reasonable to estimate that he has a 90.8% chance of making each free throw he takes. I am significantly less skilled at free throws compared to Curry, so let’s suppose that I have a 60% chance of making a given free throw. If we were to play a game where the person who makes more free throws out of 10 wins (let’s say that we reset the scores and replay the game if it is a tie), Curry would win about 98% of the time. But if Curry played this game against Kyrie Irving, a similarly skilled free-throw shooter who has made 88.2% of attempts in his career, Curry would only win about 60% of the time. If Curry were to play against himself (or someone else equally skilled and mentally prepared etc.), even Bobby Knight would have to admit that the winner was crowned based purely on luck.</p>
<p>Free throws are obviously an extreme example of a controlled situation where randomness plays a part, but every sport is made up of thousands of instances similar to this. Given the same ground ball, a baseball infielder only makes an error a small percentage of the time. Pitchers only hit the spot they were aiming for some of the time, and batters only get on base some of the time. In soccer, forwards only score some of the time whether it’s a deflected shot or a penalty kick. The same line of thought applies to teams as a whole. Luck on a team level is the sum of these luck-influenced event on the individual level of the team members plus even more events that arise from the interaction of individuals and game strategy. Even the best and most prepared center-back partnership might fail to be on the same page once during a game and that one slip up might happen at a crucial instance. A team manager might enact an optimal strategy that fails because of a referee decision. Randomness is everywhere.</p>
<p>Ultimately, the thousands of random events that make up every sporting competition result in better teams only beating worse teams some of the time. More skilled players and teams succeed in these events more often in the long run, but the differences between athletes (and teams) playing at the same level are small enough that luck plays a relatively large role in determining a competition’s winner. In baseball for example, the betting moneyline for the league-best Astros to beat the league-worst A’s at home this past August was <a href="https://sports.betmgm.com/en/blog/mlb/athletics-astros-prediction-odds-player-prop-bets-picks-aug-13-jaa/">-275</a>. These odds, which have been shown to be <a href="https://arxiv.org/pdf/1701.05976.pdf">very good predictors</a> of the true long-run odds, roughly equate to an implied winning probability of 73% for the Astros. This essentially means that worst team in the MLB still has a 27% chance of beating the best team in a given game because of randomness. If the A’s train hard and prepare well (i.e.&nbsp;improve their skill level) and/or the Astros become more error-prone due to the pressure, the win probability might shift slightly in the A’s favor, but luck will always be in play.</p>
</section>
<section id="sports-on-the-luck-skill-spectrum" class="level2">
<h2 class="anchored" data-anchor-id="sports-on-the-luck-skill-spectrum">Sports on the Luck-Skill Spectrum</h2>
<p>In his <a href="https://store.hbr.org/product/the-success-equation-untangling-skill-and-luck-in-business-sports-and-investing/10957?sku=10957E-KND-ENG">compelling book on this subject</a>, Michael Mauboussin writes in detail about the luck-skill spectrum. Gambling games like roulette and bingo are games of pure luck and chess at a high level is almost purely skill. Games like poker and blackjack lie in between but lean heavily towards luck.</p>
<p>By the same token, sports can be arranged on the spectrum too. This <a href="http://blog.philbirnbaum.com/2011/08/tango-method-of-regression-to-mean-kind.html">2011 blog post</a> written by Phil Birnbaum describes a really neat method to quantify the contribution of luck in sports leagues developed by well-known sabermetrician Tom Tango. Mauboussin writes about this method in his book as well. The underlying idea is that variance in team win-loss records at the end of a season are a sum of skill and luck:</p>
<p><span class="math display">\[
var(observed \space records) = var(skill) + var(luck)
\]</span></p>
<p>The variance from the observed records is known. An estimate for <span class="math inline">\(var(luck)\)</span> can be calculated as the theoretical variance that we would observe if each game was determined by a coin toss. More technically, this is the variance of a binomial distribution with <span class="math inline">\(p = 0.5\)</span> and <span class="math inline">\(n =\)</span> the number of games played. With two out of three terms in the above equation known, solving for <span class="math inline">\(var(skill)\)</span> is simple. The ratio of <span class="math inline">\(var(luck)\)</span> to <span class="math inline">\(var(observed \space records)\)</span> then reveals what portion of the final standings can be attributed to luck.</p>
<p>Using this method, Mauboussin ranks the NBA as the major American professional league least influence by luck and the NFL as the league most influenced by luck. This finding is largely influenced by the number of games in each league’s season. Luck plays a larger role in determining the outcome of individual MLB games compared to NFL games, but each NFL team plays 17 games in a season compared to 162 in the MLB. A larger sample size of games decreases the relative role of luck in the cumulative outcome in the same way that my probability of beating Steph Curry in the previously described free throw game is maximized (at about 13%) if the game consists of only one shot and falls below 0.01% if the game consists of 30 shots. Hence why playoff matchups, which range from best-of-one in the NFL to best-of-three in the MLB wild card round to best-of-seven in the MLB championship, are so influenced by luck<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
</section>
<section id="the-clutch-factor" class="level2">
<h2 class="anchored" data-anchor-id="the-clutch-factor">The Clutch Factor</h2>
<p>Performance in pressure situations including playoffs is frequently associated with skill of mentality, otherwise known as “clutchness”. A great deal of <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7034807/">research</a> has provided evidence that pressure impacts athletes performance and that some athletes handle it better than others. Still, this doesn’t mean that <a href="https://m.youtube.com/watch?v=bvo_ca9cTjk&amp;feature=emb_title">Kobe Bryant’s game-tying three-pointer in Game 2 of the 2004 NBA finals</a> went in simply because he has the “clutch gene” and performs well under pressure. All it means is that Kobe Bryant is skilled enough at basketball and composed enough to give himself a non-zero probability of making that shot. Then good luck did the rest. Can one made shot tell give us any confidence to conclude that Kobe has an innate ability to perform well under pressure? No.&nbsp;In fact, despite <a href="https://bleacherreport.com/articles/363340-kobe-bryant-is-the-definition-of-clutch">the narrative</a> that many pundits like to push, his <a href="https://www.espn.com/blog/truehoop/post/_/id/24200/the-truth-about-kobe-bryant-in-crunch-time">shooting statistics in high-pressure situations</a> are actually quite poor. But these numbers don’t necesarilly mean that he’s a choker who can’t handle the pressure either - they might just be a product of bad luck (or other factors such as increased double teams by opponents expecting him too shoot). We’ll never know.</p>
</section>
<section id="luck-is-a-boring-narrative-and-playoffs-are-fun-to-watch.-im-okay-with-thatfor-the-most-part" class="level2">
<h2 class="anchored" data-anchor-id="luck-is-a-boring-narrative-and-playoffs-are-fun-to-watch.-im-okay-with-thatfor-the-most-part">Luck is a boring narrative and playoffs are fun to watch. I’m okay with that…for the most part</h2>
<p>The sporting industry is one of the largest global sources of money and entertainment. In the modern age of TV and social media, the stories, predictions, and personalities surrounding sports are as central to their popularity as competetive events themselves. The purpose of sports is to entertain people, and luck-driven uncertainty and underdog stories contribute heavily to the entertainment value that sports provide. Of course, skill also plays a massive role, and it is hard to blame the media for focusing on the talent, brilliance, and hard work that led to success (well, increased probability of success) rather than the luck it required.</p>
<p>With that said, competitions that practically mirror coin-flips and then go on to claim that champions are deserving of their crown because of their skill should be frustrating for everyone involved. This is essentially what the playoffs are. Nearly every major men’s and women’s sports league in the U.S. uses a a playoff system to crown the league champion, and in nearly half, exactly half, or in the WNBA’s case more than half of the teams that participated in the long, grueling regular season qualify for these playoffs. As soon as the playoffs start, the only thing that the regular season counts for is homefield advantage (<a href="https://www.psych.rochester.edu/research/jamiesonlab/wp-content/uploads/2014/07/JJ_JASP.pdf">which only slightly benefits the home team</a>]). The team that demonstrated its superiority over the large sample size of the regular season sees hardly any reward for it come playoff time, and as the 2022 Dodgers showed us, their reputation of truly being the best team relies on having enough luck to win a best-of-five series followed by a best-of-seven series followed by another best-of-seven series. Even a team with a 70% chance of winning each game (think league-best Astros vs.&nbsp;league-worst A’s every single series) will prevail in that format less than 64% of the time.</p>
<p>Frustratingly, the amount of teams that make the playoffs has only been increasing in many leagues over recent years. Owners support this because adding playoff teams means adding playoff games, thereby increasing TV and ticket revenue. I find it extremely frustrating because it decreases the chances of deserving Champions. As <a href="https://blogs.fangraphs.com/expanded-playoffs-discourage-greatness/">some others have pointed out</a>, expanded playoff systems also harm competitions by decreasing the incentive for teams to invest in better (more skilled) rosters. On the other hand, though, European soccer leagues don’t use playoffs at all, and as a result there is (sometimes) significantly less uncertainty and excitement surrounding the title race. Ultimately, there is no format that perfectly balances luck and skill, so we will have to settle for what we’ve got.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>If the player chooses red but loses because the blue marble is picked, we would clearly call them “unlucky”. But what if they choose red (the optimal strategy) and they win because red is drawn. Did they win because they were skillfull? Or did they get lucky? Both, of course!<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>One really interesting observation that Mauboussin makes is that the influence of luck at the highest level of sports seems to be increasing with time across all leagues. The hypothesis that the improved access to extremely optimized training is pushing skill levels towards convergence at the peak of what is possible for humans is certainly intruiging.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>